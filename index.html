<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<title>Yemekhane QR Kontrol</title>
<div class="corner-logos">
    <img src="erman_ilicak_logo.png" class="logo-left" alt="Sol Logo">
    <img src="fatih.jpg" class="logo-right" alt="SaÄŸ Logo">
</div>
<div class="footer">Coded for AEIFL by Fatih Efe KORKMAZ</div>
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="style.css">
<style>
</style>
</head>
<body>
<div class="container">
  <h2>ðŸ“· QR Kod ile Yemekhane GiriÅŸi</h2>
  <div class="buttons-container">
    <button onclick="startCamera()">KamerayÄ± AÃ§</button>
    <button class="button-report" onclick="generateReport()">Rapor Al</button>
  </div>
  <div id="reader"></div>
  <div class="log" id="result"></div>
</div>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import {
  getFirestore, doc, getDoc, setDoc,
  collection, query, where, getDocs,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

// Firebase ayarlarÄ±
const firebaseConfig = {
  apiKey: "AIzaSyC7-xxih4nQaFX6Bh96yO28WJl7HpeOKW0",
  authDomain: "yemekhanem-13ff7.firebaseapp.com",
  projectId: "yemekhanem-13ff7",
  storageBucket: "yemekhanem-13ff7.appspot.com",
  messagingSenderId: "53580209245",
  appId: "1:53580209245:web:ad832d5ccfd04c110e01b4",
  measurementId: "G-J5LNZSV7WS"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let students = [];

function getMealType() {
  return (new Date().getHours() < 16) ? "lunch" : "dinner";
}

function getTodayId(code, mealType) {
  const t = new Date();
  const dateStr = t.toISOString().split("T")[0];
  return `${code}_${mealType}_${dateStr}`;
}

async function hasAlreadyEaten(code, mealType) {
  const ref = doc(db, "meals", getTodayId(code, mealType));
  const snap = await getDoc(ref);

  if (!snap.exists()) return null;

  const data = snap.data();
  if (!data.timestamp) return data;

  const now = new Date();
  const mealTime = data.timestamp.toDate();
  const diffMs = now - mealTime;
  const diffMinutes = diffMs / (1000 * 60);

  return { data, diffMinutes };
}

async function markAsEaten(code, mealType, studentName) {
  const ref = doc(db, "meals", getTodayId(code, mealType));
  await setDoc(ref, {
    code,
    name: studentName,
    mealType,
    timestamp: serverTimestamp(),
    date: new Date().toISOString().split("T")[0]
  });
  return `Logged at server time.`;
}

async function processCode(scannedCode) {
  const raw = scannedCode.trim();
  const parts = raw.split(" ");

  // Format: SINIFÅžUBE OKULNO Ä°SÄ°M SOYÄ°SÄ°M
  if (parts.length < 3) {
    showMessage("ðŸš« QR formatÄ± geÃ§ersiz. Beklenen format: '9A 607 Ä°SÄ°M SOYÄ°SÄ°M'", "error");
    return;
  }

  const classSection = parts[0];       // 9A
  const studentNumber = parts[1];      // 607
  const fullName = parts.slice(2).join(" "); // "YAVUZ SELÄ°M Ã‡INGIL"

  const normalizedCode = `${classSection} ${studentNumber} ${fullName}`.trim();

  // JSON iÃ§inde birebir eÅŸleÅŸme yapÄ±lacak
  const student = students.find(s => s.code.toUpperCase() === normalizedCode.toUpperCase());
  const mealType = getMealType();

  if (!student) {
    showMessage("ðŸš« Ã–ÄŸrenci bulunamadÄ±. Kod Ã¶ÄŸrenciler listesinde yok.", "error");
    return;
  }

  const result = await hasAlreadyEaten(normalizedCode, mealType);

  if (!result) {
    await markAsEaten(normalizedCode, mealType, student.name);
    showMessage(`âœ… ${student.name} iÃ§in ${mealType === "lunch" ? "Ã¶ÄŸle" : "akÅŸam"} yemeÄŸi verildi.`, "success");
    return;
  }

  const { data, diffMinutes } = result;

  if (diffMinutes <= 180) {
    const recordedTime = data.timestamp ? data.timestamp.toDate().toLocaleTimeString() : "N/A";
    showMessage(`âš ï¸ ${student.name} zaten yemek aldÄ± (${recordedTime}).`, "error");
    return;
  }

  await markAsEaten(normalizedCode, mealType, student.name);
  showMessage(`âœ… ${student.name} iÃ§in tekrar ${mealType === "lunch" ? "Ã¶ÄŸle" : "akÅŸam"} yemeÄŸi verildi.`, "success");
}


function showMessage(message, type = "success") {
  const resultEl = document.getElementById("result");
  resultEl.textContent = message;
  resultEl.className = `log ${type}`;
}

async function confirmDelete() {
  const first = confirm("âš ï¸ Veriler siliniyor, doÄŸrulayÄ±nÄ±z.");
  if (!first) return;

  const second = confirm("â— Bu iÅŸlem geri alÄ±namaz. Emin misiniz?");
  if (!second) return;

  const mealType = getMealType();
  const today = new Date().toISOString().split("T")[0];
  const q = query(collection(db, "meals"),
    where("date", "==", today),
    where("mealType", "==", mealType));
  const snaps = await getDocs(q);

  if (snaps.empty) {
    showMessage("ðŸ“ Silinecek veri bulunamadÄ±.", "error");
    return;
  }

  let deletedCount = 0;
  for (const docSnap of snaps.docs) {
    await docSnap.ref.delete();
    deletedCount++;
  }

  showMessage(`ðŸ—‘ï¸ ${deletedCount} kayÄ±t baÅŸarÄ±yla silindi.`, "success");
}
window.confirmDelete = confirmDelete;

const qrScanner = new Html5Qrcode("reader");
const config = { fps: 10, qrbox: 250 };
let lastScanned = "";

function startCamera() {
  if (students.length === 0) {
    showMessage("â³ Ã–ÄŸrenci listesi yÃ¼kleniyor...", "error");
    return;
  }
  document.getElementById("reader").style.display = "block";
  qrScanner.start(
    { facingMode: "environment" },
    config,
    (decodedText) => {
      const code = decodedText.trim();
      if (code !== lastScanned) {
        lastScanned = code;
        processCode(code);
        setTimeout(() => lastScanned = "", 5000);
      }
    },
    (errorMessage) => {}
  ).catch((err) => {
    showMessage("ðŸš« Kamera baÅŸlatÄ±lamadÄ±: " + err, "error");
  });
}

async function generateReport() {
  const mealType = getMealType();
  const today = new Date().toISOString().split("T")[0];
  const q = query(collection(db, "meals"),
    where("date", "==", today),
    where("mealType", "==", mealType));
  const snaps = await getDocs(q);

  if (snaps.empty) {
    showMessage("ðŸ“‹ BugÃ¼n iÃ§in yemek alan Ã¶ÄŸrenci yok.", "error");
    return;
  }

  const reportData = [['Ã–ÄŸrenci AdÄ±','Ã–ÄŸrenci ID','Yemek Saati','Ã–ÄŸÃ¼n']];
  const unique = new Set();

  snaps.forEach(d => {
    const r = d.data();
    const mealTime = r.timestamp ? r.timestamp.toDate().toLocaleTimeString() : 'N/A';
    reportData.push([r.name, r.code, mealTime, mealType === "lunch" ? "Ã–ÄŸle" : "AkÅŸam"]);
    unique.add(r.code);
  });

  reportData.push([]);
  reportData.push(['Toplam Yemek Alan KiÅŸi SayÄ±sÄ±', unique.size, '', '']);

  const ws = XLSX.utils.aoa_to_sheet(reportData);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Yemekhane");
  XLSX.writeFile(wb, `Yemekhane_Raporu_${today}.xlsx`);

  showMessage(`ðŸ“Š Rapor oluÅŸturuldu. Toplam ${unique.size} kiÅŸi.`, "success");
}

fetch("students.json")
  .then(r => r.json())
  .then(data => { students = data; })
  .catch(err => { showMessage("ðŸš« Ã–ÄŸrenci verisi yÃ¼klenemedi: " + err, "error"); });

window.startCamera = startCamera;
window.generateReport = generateReport;

</script>
</body>
</html>
