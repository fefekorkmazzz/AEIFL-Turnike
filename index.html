<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<title>Yemekhane QR Kontrol</title>
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="style.css">
<style>
</style>
</head>
<body>
<div class="corner-logos">
    <img src="erman_ilicak_logo.png" class="logo-left" alt="Sol Logo">
    <img src="fatih.jpg" class="logo-right" alt="SaÄŸ Logo">
</div>
<div class="footer">Coded for AEIFL by Fatih Efe KORKMAZ</div>
<div class="container">
  <h2>ðŸ“· QR Kod ile Yoklama Sistemi - v1.1.5.3</h2>
  <div class="search-container">
    <input type="text" id="searchInput" placeholder="Ã–ÄŸrenci adÄ± ara..." list="names">
    <datalist id="names"></datalist>
    <select id="attendanceType">
      <option value="KahvaltÄ±">KahvaltÄ±</option>
      <option value="Ã–ÄŸle YemeÄŸi">Ã–ÄŸle YemeÄŸi</option>
      <option value="AkÅŸam YemeÄŸi">AkÅŸam YemeÄŸi</option>
      <option value="EtÃ¼t">EtÃ¼t</option>
      <option value="Gezi">Gezi</option>
      <option value="Konferans">Konferans</option>
      <option value="DiÄŸer">DiÄŸer</option>
    </select>
    <input type="text" id="otherType" placeholder="Kategori adÄ±..." style="display:none;">
  </div>
  <div id="searchResult"></div>
  <div class="buttons-container">
    <button onclick="startCamera()">KamerayÄ± AÃ§</button>
    <button class="button-report" onclick="generateReport()">Rapor Al</button>
  </div>
  <div id="reader"></div>
  <div class="log" id="result"></div>
</div>
<script>
// Firebase ayarlarÄ±
// Firebase ayarlarÄ±
const firebaseConfig = {
  apiKey: "AIzaSyC7-xxih4nQaFX6Bh96yO28WJl7HpeOKW0",
  authDomain: "yemekhanem-13ff7.firebaseapp.com",
  projectId: "yemekhanem-13ff7",
  storageBucket: "yemekhanem-13ff7.appspot.com",
  messagingSenderId: "53580209245",
  appId: "1:53580209245:web:ad832d5ccfd04c110e01b4",
  measurementId: "G-J5LNZSV7WS"
};
const app = firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let students = [];

// Yemek tipi belirleme
function getMealType() {
  return (new Date().getHours() < 16) ? "lunch" : "dinner";
}

// Tarih + key ile benzersiz ID oluÅŸturma
function getTodayId(key, type) {
  const t = new Date();
  const dateStr = t.toISOString().split("T")[0];
  return `${key}_${type}_${dateStr}`;
}

// Daha Ã¶nce yemek almÄ±ÅŸ mÄ±?
async function hasAlreadyEaten(key, type) {
  const ref = db.collection("attendances").doc(getTodayId(key, type));
  const snap = await ref.get();

  if (!snap.exists) return null;

  const data = snap.data();
  if (!data.timestamp) return data;

  const now = new Date();
  const mealTime = data.timestamp.toDate();
  const diffMs = now - mealTime;
  const diffMinutes = diffMs / (1000 * 60);

  return { data, diffMinutes };
}

// Yemek aldÄ± olarak iÅŸaretle
async function markAsEaten(key, student, type) {
  const ref = db.collection("attendances").doc(getTodayId(key, type));
  await ref.set({
    key,
    name: student.name,
    gender: student.gender,
    type,
    timestamp: firebase.firestore.Timestamp.now(),
    date: new Date().toISOString().split("T")[0]
  });
}

// Ses
function playSound(type) {
  const audioContext = new (window.AudioContext || window.webkitAudioContext)();
  const oscillator = audioContext.createOscillator();
  const gainNode = audioContext.createGain();
  oscillator.connect(gainNode);
  gainNode.connect(audioContext.destination);

  if (type === 'success') {
    oscillator.frequency.value = 800;
    oscillator.type = 'sine';
  } else {
    oscillator.frequency.value = 400;
    oscillator.type = 'sawtooth';
  }

  gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
  gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
  oscillator.start(audioContext.currentTime);
  oscillator.stop(audioContext.currentTime + 0.2);
}

// ðŸ”¥ QR kod iÅŸleme fonksiyonu (KAYIPTI â€” EKLEDÄ°M)
async function processCode(scannedKey) {
  const key = scannedKey.trim();
  const student = students.find(s => s.key === key);
  let type = document.getElementById('attendanceType').value;
  if (type === 'DiÄŸer') {
    const other = document.getElementById('otherType').value.trim();
    if (other) type = other;
  }

  if (!student) {
    showMessage("ðŸš« Ã–ÄŸrenci bulunamadÄ±. Kod Ã¶ÄŸrenciler listesinde yok.", "error");
    playSound('error');
    return;
  }

  const result = await hasAlreadyEaten(key, type);

  // Ä°lk kez geliyorsa
  if (!result) {
    await markAsEaten(key, student, type);
    showMessage(`âœ… ${student.name} ${type} yoklamasÄ±na katÄ±ldÄ±.`, "success");
    playSound('success');
    return;
  }

  // Daha Ã¶nce gelmiÅŸ
  const { data, diffMinutes } = result;

  if (diffMinutes <= 180) {
    const recordedTime = data.timestamp ? data.timestamp.toDate().toLocaleTimeString() : "N/A";
    showMessage(`âš ï¸ ${student.name} zaten katÄ±ldÄ± (${recordedTime}).`, "error");
    playSound('error');
    return;
  }

  // 3 saatten fazla geÃ§miÅŸse tekrar alabilir
  await markAsEaten(key, student, type);
  showMessage(`âœ… ${student.name} iÃ§in QR Kod tarandÄ±`, "success");
  playSound('success');
}

// Ekrana mesaj yazdÄ±rma
function showMessage(message, type = "success") {
  const resultEl = document.getElementById("result");
  resultEl.textContent = message;
  resultEl.className = `log ${type}`;
}

// QR tarayÄ±cÄ±
const qrScanner = new Html5Qrcode("reader");
const config = { fps: 10, qrbox: 250 };
let lastScanned = "";

// Kamera baÅŸlatma
function startCamera() {
  if (students.length === 0) {
    showMessage("â³ Ã–ÄŸrenci listesi yÃ¼kleniyor...", "error");
    return;
  }

  document.getElementById("reader").style.display = "block";

  qrScanner.start(
    { facingMode: "environment" },
    config,
    (decodedText) => {
      const code = decodedText.trim();

      if (code !== lastScanned) {
        lastScanned = code;
        processCode(code);
        setTimeout(() => (lastScanned = ""), 3000);
      }
    },
    () => { }
  ).catch(err => {
    showMessage("ðŸš« Kamera baÅŸlatÄ±lamadÄ±: " + err, "error");
  });
}

// Rapor oluÅŸturma
async function generateReport() {
  const today = new Date().toISOString().split("T")[0];

  const q = db.collection("attendances").where("date", "==", today);

  const snaps = await q.get();

  if (snaps.empty) {
    showMessage("ðŸ“‹ BugÃ¼n iÃ§in katÄ±lÄ±m yok.", "error");
    return;
  }

  const typeGroups = {};

  snaps.forEach(d => {
    const r = d.data();
    const type = r.type || "Yemekhane";
    if (!typeGroups[type]) {
      typeGroups[type] = { all: [], males: [], females: [], uniqueAll: new Set(), uniqueMales: new Set(), uniqueFemales: new Set() };
    }
    const time = r.timestamp ? r.timestamp.toDate().toLocaleTimeString() : "N/A";
    const row = [r.name, r.key, r.gender, time, "Evet"];
    typeGroups[type].all.push(row);
    if (r.gender === "E") {
      typeGroups[type].males.push(row);
      typeGroups[type].uniqueMales.add(r.key);
    } else if (r.gender === "K") {
      typeGroups[type].females.push(row);
      typeGroups[type].uniqueFemales.add(r.key);
    }
    typeGroups[type].uniqueAll.add(r.key);
  });

  const wb = XLSX.utils.book_new();

  Object.keys(typeGroups).forEach(type => {
    const group = typeGroups[type];
    const wsAll = XLSX.utils.aoa_to_sheet([['Ad', 'Key', 'Cinsiyet', 'Saat', 'KatÄ±ldÄ±'], ...group.all]);
    XLSX.utils.book_append_sheet(wb, wsAll, `${type} - TÃ¼mÃ¼`);

    const wsM = XLSX.utils.aoa_to_sheet([['Ad', 'Key', 'Cinsiyet', 'Saat', 'KatÄ±ldÄ±'], ...group.males]);
    XLSX.utils.book_append_sheet(wb, wsM, `${type} - Erkek`);

    const wsF = XLSX.utils.aoa_to_sheet([['Ad', 'Key', 'Cinsiyet', 'Saat', 'KatÄ±ldÄ±'], ...group.females]);
    XLSX.utils.book_append_sheet(wb, wsF, `${type} - KÄ±z`);
  });

  XLSX.writeFile(wb, `Katilim_Raporu_${today}.xlsx`);

  const summary = Object.keys(typeGroups).map(type => `${type}: ${typeGroups[type].uniqueAll.size}`).join(', ');
  showMessage(`ðŸ“Š Rapor oluÅŸturuldu. ${summary}`, "success");
}

// Ã–ÄŸrencileri JSON'dan yÃ¼kle
fetch('students.json')
  .then(response => response.json())
  .then(data => {
    students = data;
    console.log("Students loaded:", students.length);
    // Datalist doldur
    const datalist = document.getElementById('names');
    const uniqueNames = new Set();
    students.forEach(s => uniqueNames.add(s.name));
    uniqueNames.forEach(name => {
      const option = document.createElement('option');
      option.value = name;
      datalist.appendChild(option);
    });
  })
  .catch(err => {
    console.error('JSON yÃ¼klenirken hata oluÅŸtu:', err);
    showMessage("ðŸš« Ã–ÄŸrenci verisi yÃ¼klenemedi: " + err, "error");
  });

// Yoklama tÃ¼rÃ¼ seÃ§imi
document.getElementById('attendanceType').addEventListener('change', function() {
  const otherInput = document.getElementById('otherType');
  if (this.value === 'DiÄŸer') {
    otherInput.style.display = 'block';
  } else {
    otherInput.style.display = 'none';
    otherInput.value = '';
  }
});

// Arama input'u bÃ¼yÃ¼k harf yap ve ara
document.getElementById('searchInput').addEventListener('input', async function() {
  this.value = this.value.toLocaleUpperCase('tr');
  const searchTerm = this.value.trim();
  const resultDiv = document.getElementById('searchResult');
  if (searchTerm === '') {
    resultDiv.textContent = '';
    return;
  }
  const today = new Date().toISOString().split("T")[0];
  try {
    const q = db.collection("attendances").where("name", "==", searchTerm).where("date", "==", today);
    const snaps = await q.get();
    if (snaps.empty) {
      resultDiv.textContent = "Ã–ÄŸrenciye ait kayÄ±t bulunamadÄ±";
      resultDiv.className = "search-result error";
    } else {
      const records = [];
      snaps.forEach(doc => {
        const data = doc.data();
        const time = data.timestamp.toDate().toLocaleTimeString();
        records.push(`${searchTerm} ${time} tarihinde ${data.type} yoklamasÄ±nda`);
      });
      resultDiv.innerHTML = records.join('<br>');
      resultDiv.className = "search-result success";
    }
  } catch (err) {
    resultDiv.textContent = "Arama hatasÄ±: " + err.message;
    resultDiv.className = "search-result error";
  }
});

// Fonksiyon eriÅŸimleri
window.startCamera = startCamera;
window.generateReport = generateReport;


</script>
</body>
</html>


