<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<title>Yemekhane QR Kontrol</title>
<div class="corner-logos">
    <img src="erman_ilicak_logo.png" class="logo-left" alt="Sol Logo">
    <img src="fatih.jpg" class="logo-right" alt="SaÄŸ Logo">
</div>
<div class="footer">Coded for AEIFL by Fatih Efe KORKMAZ</div>
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="style.css">
<style>
</style>
</head>
<body>
<div class="container">
  <h2>ðŸ“· QR Kod ile Yemekhane GiriÅŸi</h2>
  <div class="buttons-container">
    <button onclick="startCamera()">KamerayÄ± AÃ§</button>
    <button class="button-report" onclick="generateReport()">Rapor Al</button>
  </div>
  <div id="reader"></div>
  <div class="log" id="result"></div>
</div>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import {
  getFirestore, doc, getDoc, setDoc,
  collection, query, where, getDocs,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

// Firebase ayarlarÄ±
const firebaseConfig = {
  apiKey: "AIzaSyC7-xxih4nQaFX6Bh96yO28WJl7HpeOKW0",
  authDomain: "yemekhanem-13ff7.firebaseapp.com",
  projectId: "yemekhanem-13ff7",
  storageBucket: "yemekhanem-13ff7.appspot.com",
  messagingSenderId: "53580209245",
  appId: "1:53580209245:web:ad832d5ccfd04c110e01b4",
  measurementId: "G-J5LNZSV7WS"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let students = [];

function getMealType() {
  return (new Date().getHours() < 16) ? "lunch" : "dinner";
}

function getTodayId(key, mealType) {
  const t = new Date();
  const dateStr = t.toISOString().split("T")[0];
  return `${key}_${mealType}_${dateStr}`;
}

async function hasAlreadyEaten(key, mealType) {
  const ref = doc(db, "meals", getTodayId(key, mealType));
  const snap = await getDoc(ref);

  if (!snap.exists()) return null;

  const data = snap.data();
  if (!data.timestamp) return data;

  const now = new Date();
  const mealTime = data.timestamp.toDate();
  const diffMs = now - mealTime;
  const diffMinutes = diffMs / (1000 * 60);

  return { data, diffMinutes };
}

async function markAsEaten(key, student, mealType) {
  const ref = doc(db, "meals", getTodayId(key, mealType));
  await setDoc(ref, {
    key,
    name: student.name,
    gender: student.gender,   // ðŸ”¥ gender artÄ±k kayÄ±t ediliyor
    mealType,
    timestamp: serverTimestamp(),
    date: new Date().toISOString().split("T")[0]
  });
}


// QR kodu iÅŸleme fonksiyonu
async function processCode(scannedKey) {
  const key = scannedKey.trim();

  const student = students.find(s => s.key === key);

  const mealType = getMealType();

  if (!student) {
    showMessage("ðŸš« Ã–ÄŸrenci bulunamadÄ±. Kod Ã¶ÄŸrenciler listesinde yok.", "error");
    return;
  }

  const result = await hasAlreadyEaten(key, mealType);

  if (!result) {
    await markAsEaten(key, student.name, mealType);
    showMessage(`âœ… ${student.name} iÃ§in ${mealType === "lunch" ? "Ã¶ÄŸle" : "akÅŸam"} yemeÄŸi verildi.`, "success");
    return;
  }

  const { data, diffMinutes } = result;

  if (diffMinutes <= 180) {
    const recordedTime = data.timestamp ? data.timestamp.toDate().toLocaleTimeString() : "N/A";
    showMessage(`âš ï¸ ${student.name} zaten yemek aldÄ± (${recordedTime}).`, "error");
    return;
  }

  await markAsEaten(key, student, mealType);
  showMessage(`âœ… ${student.name} iÃ§in tekrar ${mealType === "lunch" ? "Ã¶ÄŸle" : "akÅŸam"} yemeÄŸi verildi.`, "success");
}

function showMessage(message, type = "success") {
  const resultEl = document.getElementById("result");
  resultEl.textContent = message;
  resultEl.className = `log ${type}`;
}

async function confirmDelete() {
  const first = confirm("âš ï¸ Veriler siliniyor, doÄŸrulayÄ±nÄ±z.");
  if (!first) return;

  const second = confirm("â— Bu iÅŸlem geri alÄ±namaz. Emin misiniz?");
  if (!second) return;

  const mealType = getMealType();
  const today = new Date().toISOString().split("T")[0];
  const q = query(collection(db, "meals"),
    where("date", "==", today),
    where("mealType", "==", mealType));
  const snaps = await getDocs(q);

  if (snaps.empty) {
    showMessage("ðŸ“ Silinecek veri bulunamadÄ±.", "error");
    return;
  }

  let deletedCount = 0;
  for (const docSnap of snaps.docs) {
    await docSnap.ref.delete();
    deletedCount++;
  }

  showMessage(`ðŸ—‘ï¸ ${deletedCount} kayÄ±t baÅŸarÄ±yla silindi.`, "success");
}
window.confirmDelete = confirmDelete;

const qrScanner = new Html5Qrcode("reader");
const config = { fps: 10, qrbox: 250 };
let lastScanned = "";

function startCamera() {
  if (students.length === 0) {
    showMessage("â³ Ã–ÄŸrenci listesi yÃ¼kleniyor...", "error");
    return;
  }
  document.getElementById("reader").style.display = "block";
  qrScanner.start(
    { facingMode: "environment" },
    config,
    (decodedText) => {
      const code = decodedText.trim();
      if (code !== lastScanned) {
        lastScanned = code;
        processCode(code);
        setTimeout(() => lastScanned = "", 5000);
      }
    },
    (errorMessage) => {}
  ).catch((err) => {
    showMessage("ðŸš« Kamera baÅŸlatÄ±lamadÄ±: " + err, "error");
  });
}

async function generateReport() {
  const mealType = getMealType();
  const today = new Date().toISOString().split("T")[0];

  const q = query(
    collection(db, "meals"),
    where("date", "==", today),
    where("mealType", "==", mealType)
  );

  const snaps = await getDocs(q);

  if (snaps.empty) {
    showMessage("ðŸ“‹ BugÃ¼n iÃ§in yemek alan Ã¶ÄŸrenci yok.", "error");
    return;
  }

  const allData = [];
  const males = [];
  const females = [];
  const uniqueAll = new Set();
  const uniqueMales = new Set();
  const uniqueFemales = new Set();

  snaps.forEach(d => {
    const r = d.data();
    const time = r.timestamp ? r.timestamp.toDate().toLocaleTimeString() : "N/A";

    const row = [r.name, r.key, r.gender, time, mealType === "lunch" ? "Ã–ÄŸle" : "AkÅŸam"];

    allData.push(row);

    if (r.gender === "E") {
      males.push(row);
      uniqueMales.add(r.key);
    } else if (r.gender === "K") {
      females.push(row);
      uniqueFemales.add(r.key);
    }

    uniqueAll.add(r.key);
  });

  const wb = XLSX.utils.book_new();

  // TÃ¼m Ã¶ÄŸrenciler
  const wsAll = XLSX.utils.aoa_to_sheet([['Ad', 'Key', 'Cinsiyet', 'Saat', 'Ã–ÄŸÃ¼n'], ...allData]);
  XLSX.utils.book_append_sheet(wb, wsAll, "TÃ¼mÃ¼");

  // Erkek
  const wsM = XLSX.utils.aoa_to_sheet([['Ad', 'Key', 'Cinsiyet', 'Saat', 'Ã–ÄŸÃ¼n'], ...males]);
  XLSX.utils.book_append_sheet(wb, wsM, "Erkek");

  // KÄ±z
  const wsF = XLSX.utils.aoa_to_sheet([['Ad', 'Key', 'Cinsiyet', 'Saat', 'Ã–ÄŸÃ¼n'], ...females]);
  XLSX.utils.book_append_sheet(wb, wsF, "KÄ±z");

  XLSX.writeFile(wb, `Yemekhane_Rapor_${today}.xlsx`);

  showMessage(`ðŸ“Š Rapor oluÅŸturuldu. TÃ¼mÃ¼: ${uniqueAll.size}, Erkek: ${uniqueMales.size}, KÄ±z: ${uniqueFemales.size}`, "success");
}

fetch('students.json')
  .then(response => response.json())
  .then(data => { students = data; })
  .catch(err => {
    console.error('JSON dosyasÄ±nÄ± yÃ¼klerken bir hata oluÅŸtu:', err);
    showMessage("ðŸš« Ã–ÄŸrenci verisi yÃ¼klenemedi: " + err, "error");
  });

window.startCamera = startCamera;
window.generateReport = generateReport;

</script>
</body>
</html>
